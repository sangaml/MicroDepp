# Starter pipeline
# Start with a minimal pipeline that you can customize to build and deploy your code.
# Add steps that build, run tests, deploy, and more:
# https://aka.ms/yaml

trigger:
- master

pool:
  name: 'sangampool'

variables:
  dockerId: sangamlonk  # Replace with your Docker ID for Docker Hub or the admin user name for the Azure Container Registry
  imageName: nodejsms  # Replace with the name of the image you want to publish

steps:
- script: |
    echo Nodejs Conatiner's Current Build Version: $BUILD_BUILDNUMBER > version.txt
    docker build -t $(dockerId).azurecr.io/$(imageName):$BUILD_BUILDNUMBER . 
    az login --service-principal -u $(appid) -p $(secretkey) --tenant $(tenant)
    az acr login --name $(dockerId)
    echo "Hello Baba"
    docker push $(dockerId).azurecr.io/$(imageName):$BUILD_BUILDNUMBER
    cp Dockerfile $(Build.ArtifactStagingDirectory)/
    mkdir $(Build.ArtifactStagingDirectory)/terraform
    cp deploy_aks_Pod.tf $(Build.ArtifactStagingDirectory)/terraform
    cp Deploy_image_Openshift.sh $(Build.ArtifactStagingDirectory)/
#  env:
#    pswd: $(dockerPassword)        # Define dockerPassword in the Variables tab of this pipeline in Pipelines page of web interface

- task: PublishBuildArtifacts@1
  displayName: 'Publish Artifact: drop'
