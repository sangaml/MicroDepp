# Starter pipeline
# Start with a minimal pipeline that you can customize to build and deploy your code.
# Add steps that build, run tests, deploy, and more:
# https://aka.ms/yaml

trigger:
- master

pool:
  name: 'sangampool'

variables:
  dockerId: sangamlonk  # Replace with your Docker ID for Docker Hub or the admin user name for the Azure Container Registry
  imageName: nodejsms  # Replace with the name of the image you want to publish

steps:
- script: |
    echo "Nodejs Conatiner's Current Build Version: $BUILD_BUILDNUMBER" > version.txt
    docker build -t $(dockerId).azurecr.io/$(imageName):$BUILD_BUILDNUMBER . 
    az login --service-principal -u $(appid) -p $(secretkey) --tenant $(tenant)
    az acr login --name $(dockerId)
    echo "Hello Baba"
    echo "$(appid)"
    docker push $(dockerId).azurecr.io/$(imageName):$BUILD_BUILDNUMBER
    cp Dockerfile $(Build.ArtifactStagingDirectory)/
    mkdir $(Build.ArtifactStagingDirectory)/terraform
    cp deploy_aks.tf $(Build.ArtifactStagingDirectory)/terraform
  #  echo $(ostoken)
  #  envsubst \$(ostoken) <devdeploy.sh  >devdeploy2.sh 
  #  cat devdeploy2.sh 
  #  cp devdeploy2.sh $(Build.ArtifactStagingDirectory)/devdeploy.sh
  displayName: 'Build container and push to ACR'  
    
    
#  env:
#    pswd: $(dockerPassword)        # Define dockerPassword in the Variables tab of this pipeline in Pipelines page of web interface

- task: PublishBuildArtifacts@1
  displayName: 'Publish Artifact: drop'
