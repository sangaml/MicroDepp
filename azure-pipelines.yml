# Starter pipeline
# Start with a minimal pipeline that you can customize to build and deploy your code.
# Add steps that build, run tests, deploy, and more:
# https://aka.ms/yaml

trigger:
- master

pool:
  name: 'sangampool'

variables:
  dockerId: microdepp  # Replace with your Docker ID for Docker Hub or the admin user name for the Azure Container Registry
  imageName: rsvp  # Replace with the name of the image you want to publish
  dbimageName: mongo

steps:
- script: |
    az login --service-principal -u $(appid) -p $(secretkey) --tenant $(tenant)
    az acr login --name $(dockerId)
    docker build -t $(dockerId).azurecr.io/$(dbimageName):$BUILD_BUILDNUMBER ./mongo
    docker build -t $(dockerId).azurecr.io/$(imageName):$BUILD_BUILDNUMBER ./rsvpapp 
    docker push $(dockerId).azurecr.io/$(imageName):"$BUILD_BUILDNUMBER"
    docker push $(dockerId).azurecr.io/$(dbimageName):"$BUILD_BUILDNUMBER"
    #cp Dockerfile $(Build.ArtifactStagingDirectory)/
    mkdir $(Build.ArtifactStagingDirectory)/k8s
    cp ./k8s/* $(Build.ArtifactStagingDirectory)/k8s/
  displayName: 'Build APP & DB containers and push to $(dockerId).azurecr.io'  
    
- task: PublishBuildArtifacts@1
  displayName: 'Publish Artifact: drop'
